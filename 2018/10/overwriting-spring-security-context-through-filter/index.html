<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Zhenyang Hua</title>
  <link rel="stylesheet" href="/assets/global.374079e1.css">
<link rel="stylesheet" href="/assets/style.module.184703f0.css"></head>
<body><div id="contentcontainer" class="shadow"><div class="host_1vq48fc" style="background-color: rgb(21, 228, 89);"><header><div class="host_1q8y6om"><a href="#maincontent">skip to main content</a></div><div class="host_216t9o"><h2 class="title_216t9o"><a href="/">Zhenyang Hua</a></h2></div><div class="host_m2uvri"><nav><h2 class="hidden">Main Navigation</h2><ul><li><a href="/" class="link_m2uvri">Tools</a></li><li><a href="/writings/1" class="link_m2uvri">Writings</a></li></ul></nav></div><div class="host_1c336ft"><span>This is a space that holds a collection of my personal work and ideas</span></div></header></div><main id="maincontent"><div class="post_14b9dxr"><h1 class="title_14b9dxr">Overwriting Spring Security Context through Filter</h1><p class="date_14b9dxr">Posted on 10/30/2018</p><div class="summary_14b9dxr"><p>This article presents a strategy that overwrites the spring security context in order to allow a user to visit the resources without authenticating the user through the authentication filters.</p>
</div><article><p>It is very common that in a single-sign-on application to use a session store to persist the session information after the user has successfully signed in. Spring Session magically takes care this for us if we add <code>@enableXxxHttpSession</code> to the application configuration. While it is convenient to use an out-of-the-box solution, it is extremely helpful to implement one so each fundamental part of this pattern can be fully understood.  This insight can improve the efficiency of the code by way of a more optimal choice of scope for any session store, even to make a home-made one.</p>
<p>We will create a <code>javax.servlet.Filter</code> implementation so we could add this filter as part of the security filter chain.</p>
<p>The place this filter should be inserted is before the <code>SecurityContextPersistenceFilter</code>.</p>
<p>In this example, instead of using a home-made repository for session store, we will use the <code>MongoOperationsSessionRepository</code> from the Spring Session. This repository persists the session information to a collection named <strong>sessions</strong> into the configured MongoDB instance. When manually setting up the <code>SessionRepository</code> interface, it is recommended to also manually setup the <code>GenericConverter</code> so that the session repository knows how to properly serialize and deserialize the session object.</p>
<div class="codeblock">
  <pre class="language-java"><span class="token keyword">private</span> <span class="token class-name">MongoOperationsSessionRepository</span> sessionRepository<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token class-name">SessionFilter</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MongoOperations</span> mongoOperations<span class="token punctuation">,</span>
                     <span class="token keyword">final</span> <span class="token class-name">AbstractMongoSessionConverter</span> sessionConverter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sessionRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoOperationsSessionRepository</span><span class="token punctuation">(</span>mongoOperations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepository<span class="token punctuation">.</span><span class="token function">setMongoSessionConverter</span><span class="token punctuation">(</span>sessionConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre>  
</div><p>Assume the client will send a cookie containing session id along with the request to the server, we will get the session id from the cookie and then look it up from the session store, and in this case, it is the <code>MongoOperationsSessionRepository</code> instance. We should conduct some expected session validation checking and then start overriding the security context.</p>
<div class="codeblock">
  <pre class="language-java"><span class="token class-name">HttpServletRequest</span> httpRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
<span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getCookie</span><span class="token punctuation">(</span>httpRequest<span class="token punctuation">,</span> COOKIE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cookie <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sessionId <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MongoExpiringSession</span> session <span class="token operator">=</span> sessionRepository<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> session<span class="token punctuation">.</span><span class="token function">getExpireAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>ATTR_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Overwriting the security context</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>  
</div><p>It is a three-step process to overwrite the spring security context:</p>
<ol>
<li>Get the security context</li>
<li>Set its new authentication</li>
<li>Assign the security context to the <code>HttpSession</code></li>
</ol>
<div class="codeblock">
  <pre class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SecurityContext</span> sc <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sc<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpRequest<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>SPRING_SECURITY_CONTEXT_KEY<span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre>  
</div><p>Follow these above steps, we get ourselves a security context with our new authentication! </p>
</article><h2 class="github_14b9dxr"><a target="_blank" href="https://github.com/zhenyanghua/zhenyanghua.github.io/blob/master/posts/2018/10/overwriting-spring-security-context-through-filter/index.md">Read on GitHub</a></h2></div></main></div><script type="isodata"></script>
  <script type="module" src="/index.64822b5c.js"></script>
</body>
</html>

