import{m as e}from"../index.7b723884.js";import"./time.daaab1ba.js";import{P as n}from"./index.900a25fd.js";export default function(){return e`<${n} ...${{title:"Spring Data MongoDB GridFS 3.4",date:"2018-10-17 17:00:00"}}>
      <article dangerouslySetInnerHTML=${{__html:'<p>This article shows a typical usage of MongoDB GridFS with Spring Data MongoDB. This is for MongoDB java driver v3.4 and Spring Data MongoDB v1.10.x. Note that Spring Data MongoDB v2.X introduces breaking changes with the MongoDB java driver 3.6+. This article only shows the usage of the v3.4 driver with Spring Data MongoDB v1.10.x.</p>\n\x3c!-- Excerpt End --\x3e\n\n<h2>\n  <a id="fileservice-interface" class="anchor" aria-hidden="true" href="#fileservice-interface">\n    <svg class="icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg>\n  </a>FileService Interface</h2><div class="codeblock">\n  <pre>public interface FileService {\n    GridFSDBFile find(String id);\n    Optional&lt;GridFsResource&gt; findAsResource(String id);\n    String store(String name, MultipartFile file);\n    void delete(String id);\n}</pre>\n</div><h2>\n  <a id="fileservice-implementation" class="anchor" aria-hidden="true" href="#fileservice-implementation">\n    <svg class="icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg>\n  </a>FileService Implementation</h2><p>We can&#39;t use <code>GridFsTemplate.getResource(String location)</code> here to get the resource because there might be files with the same name. To find the expected file, we need to find a list of the resources that all match the same filename and then filter them by the id after retrieving all the files. This is acceptable because at that point, the <code>InputStream</code> hasn&#39;t been requested yet. <code>GridFsTemplate.getResources(String locationPattern)</code> takes an Ant matching pattern and it returns all resources whose filename passes the test.</p>\n<p><code>GridFsTemplate.store()</code> returns an <code>Object</code> whose string literal could be converted to a <code>ObjectId</code> type. For instance,\n<code>ObjectId objectId = new ObjectId(GridFsTemplate.store(...).toString())</code>.</p>\n<div class="codeblock">\n  <pre>@Service\npublic class FileServiceImpl implements FileService {\n    private GridFsTemplate gridFsTemplate;\n\n    @Autowired\n    public FileServiceImpl(final GridFsTemplate gridFsTemplate) {\n        this.gridFsTemplate = gridFsTemplate;\n    }\n\n\n    @Override\n    public GridFSDBFile find(final String id) {\n        ObjectId objectId = new ObjectId(id);\n        return gridFsTemplate.findOne(new Query(Criteria.where(&quot;_id&quot;).is(objectId)));\n    }\n\n    @Override\n    public Optional&lt;GridFsResource&gt; findAsResource(final String id) {\n        return Stream.of(gridFsTemplate.getResources(find(id).getFilename() + &quot;*&quot;))\n            .filter(gridFsResource -&gt; gridFsResource.getId().toString().equals(id))\n            .findAny();\n    }\n\n    @Override\n    public String store(String name, final MultipartFile file) {\n        try {\n            String filename = file.getOriginalFilename();\n            if (name != null) {\n                filename = FileNameUtils.getExtension(filename)\n                    .map(ext -&gt; name + &quot;.&quot; + ext)\n                    .orElse(name);\n            }\n\n            InputStream inputStream = file.getInputStream();\n            GridFSFile gridFSFile = gridFsTemplate.store(\n                inputStream, filename, file.getContentType());\n            if (gridFSFile != null) {\n                return gridFSFile.getId().toString();\n            } throw new FileException(&quot;Failed to save file&quot;);\n        } catch (IOException e) {\n            throw new FileException(e);\n        }\n    }\n\n    @Override\n    public void delete(final String id) {\n        ObjectId objectId = new ObjectId(id);\n        gridFsTemplate.delete(new Query(Criteria.where(&quot;_id&quot;).is(objectId)));\n    }\n}</pre>\n</div><h2>\n  <a id="filecontroller" class="anchor" aria-hidden="true" href="#filecontroller">\n    <svg class="icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg>\n  </a>FileController</h2><div class="codeblock">\n  <pre>@RestController\n@RequestMapping(&quot;/api/v1/files&quot;)\npublic class FileController {\n    private FileService fileService;\n\n    @Autowired\n    public FileController(final FileService fileService) {\n        this.fileService = fileService;\n    }\n\n    @PostMapping\n    public Attachment uploadAttachment(@RequestParam(&quot;name&quot;) String name,\n                                 @RequestParam(&quot;file&quot;) MultipartFile file) {\n        String id =  fileService.store(name, file);\n        return new Attachment(name, id);\n    }\n\n    @GetMapping(&quot;/{id}&quot;)\n    public ResponseEntity&lt;InputStreamResource&gt; downloadFile(@PathVariable(&quot;id&quot;) String id) {\n        Optional&lt;GridFsResource&gt; resourceOptional = fileService.findAsResource(id);\n\n        return resourceOptional.map(resource -&gt; {\n            try {\n                return ResponseEntity\n                    .ok()\n                    .contentType(MediaType.valueOf(resource.getContentType()))\n                    .header(HttpHeaders.CONTENT_DISPOSITION,\n                        &quot;attachment; filename=&quot;&quot; + resource.getFilename() + &quot;&quot;&quot;)\n                    .body(new InputStreamResource(resource.getInputStream()));\n            } catch (IOException e) {\n                throw new FileException(e);\n            }\n        }).orElseThrow(() -&gt; new FileException(&quot;File not found&quot;));\n    }\n\n    @DeleteMapping(&quot;/{id}&quot;)\n    public void deleteFile(@PathVariable(&quot;id&quot;) String id) {\n        fileService.delete(id);\n    }\n\n    class Attachment {\n        private String name;\n        private String fileId;\n\n        Attachment(final String name, final String fileId) {\n            this.name = name;\n            this.fileId = fileId;\n        }\n        // Getters and setters...\n    }\n\n}</pre>\n</div><h2>\n  <a id="references" class="anchor" aria-hidden="true" href="#references">\n    <svg class="icon" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg>\n  </a>References</h2><ol>\n<li><a href="http://mongodb.github.io/mongo-java-driver/3.4/javadoc/" target="_blank">Mongo Java Driver v3.4</a></li>\n<li><a href="https://docs.spring.io/spring-data/mongodb/docs/1.10.16.RELEASE/api/" target="_blank">Spring Data MongoDB v.1.10.16 API</a></li>\n<li><a href="https://docs.spring.io/spring-data/mongodb/docs/1.10.16.RELEASE/reference/html/" target="_blank">Spring Data MongoDB v.1.10.16 Reference</a></li>\n</ol>\n'}}/>
    </${n}>`}